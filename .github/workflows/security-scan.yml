# .github/workflows/security-scan.yml

name: Security Scan (Weekly)

on:
  schedule:
    # Run every Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  # ============================================================================
  # OWASP ZAP SCAN
  # ============================================================================
  zap-scan:
    name: OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd backend
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start backend server
        env:
          # Use dummy variables for the server to start
          DATABASE_URL: "postgresql://user:pass@localhost/db" # pragma: allowlist secret
          REDIS_URL: "redis://localhost:6379/0"
          JWT_SECRET_KEY: "test-secret-key-min-32-characters-long" # pragma: allowlist secret
          ENCRYPTION_KEY: "test-encryption-key-32-chars!!"
          ENVIRONMENT: "test"
        run: |
          cd backend
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          # Wait for the server to be ready
          sleep 15

      - name: ZAP Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          target: 'http://localhost:8000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          issue_title: 'OWASP ZAP Security Issues'
          token: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # DEPENDENCY SCANNING
  # ============================================================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install safety

      - name: Run Safety check
        run: |
          cd backend
          pip install -r requirements.txt
          pip install -r requirements-dev.txt
          python -m safety check -r requirements.txt -r requirements-dev.txt --full-report

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Frontend dependency check
        run: |
          cd apps/web
          npm ci
          npm audit

  # ============================================================================
  # SECRET SCANNING
  # ============================================================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
